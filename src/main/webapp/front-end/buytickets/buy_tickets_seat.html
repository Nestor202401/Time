<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>立即購票</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
	crossorigin="anonymous">
<link
	href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
	rel="stylesheet">
		<!-- icon link -->
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
<style>
body {
	margin: 0;
	font-family: 'Poppins', sans-serif;
	color: #fff;
	background-color: #0c0c0c;
	display: flex;
	flex-direction: column;
	min-height: 100vh;
}

main {
	flex: 1;
}

.footer {
	background-color: #1c1c1c;
	padding: 20px;
	text-align: center;
}

.footer .nav-links {
	margin-bottom: 10px;
}

.footer .nav-links a {
	margin: 0 15px;
	color: #fff;
	text-decoration: none;
	font-size: 14px;
}

.footer .nav-links a:hover {
	text-decoration: underline;
}

.footer .logo {
	display: block;
	margin: 0 auto 10px;
	max-width: 150px;
}

.footer .social-icons {
	margin: 10px 0;
}

.footer .social-icons a {
	margin: 0 10px;
	color: #fff;
	text-decoration: none;
	font-size: 20px;
}

.footer .social-icons a:hover {
	color: #ccc;
}

.footer .copyright {
	font-size: 12px;
	color: #ccc;
}

.footer .policy-links {
	margin-top: 10px;
}

.footer .policy-links a {
	margin: 0 5px;
	color: #ccc;
	text-decoration: none;
	font-size: 12px;
}

.footer .policy-links a:hover {
	text-decoration: underline;
}

header {
	background-color: #000;
	padding: 20px 0;
	width: 100%; /* Full width */
}

.container99 {
	width: 90%;
	max-width: 1200px;
	margin: 0 auto;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

nav ul {
	list-style: none;
	display: flex;
	gap: 30px; /* Increased gap between items */
	margin: 0;
	padding: 0;
}

nav ul li a {
	color: #fff;
	text-decoration: none;
	font-weight: 600;
	font-size: 18px; /* Increased font size */
	padding: 10px 15px; /* Added padding */
	transition: color 0.3s ease; /* Added transition for smooth effect */
}

nav ul li a:hover {
	color: #ffd700; /* Change text color on hover */
}

.auth-buttons99 button {
	background-color: #ffd700;
	border: none;
	padding: 10px 20px;
	cursor: pointer;
	font-size: 18px; /* Increased font size */
	border-radius: 5px;
	font-weight: 600;
	transition: background-color 0.3s ease;
	/* Added transition for smooth effect */
}

.auth-buttons99 button:hover {
	background-color: #e0c000; /* Change background color on hover */
}

.outer-container {
	display: flex;
	justify-content: center; /* 水平居中 */
	width: 100%; /* 讓外部容器占滿全寬 */
}

.container {
	width: 85%; /* 設置容器寬度 */
	overflow: auto; /* 清除浮動 */
	display: flex;
	justify-content: space-between; /* 子元素之間均勻分布 */
}

.box {
	padding: 20px; /* 內邊距 */
	border: 3.5px solid #6C6C6C; /* 邊框 */
	box-sizing: border-box; /* 盒子大小包含邊框 */
	color: black;
	font-size: 20px;
	border-top-left-radius: 15px; /* 左上角圓角 */
	border-top-right-radius: 15px; /* 右上角圓角 */
}

.box1 {
	width: 50%; /* 設置第一個盒子寬度 */
	background-color: lightblue; /* 背景色 */
}

.box2 {
	width: 35%; /* 設置第二個盒子寬度 */
	background-color: lightgreen; /* 背景色 */
}

h2 {
	color: #333;
}

.cinema {
	display: flex;
	flex-direction: column;
	align-items: center;
}

.screen {
	background-color: #555;
	color: white;
	padding: 10px;
	margin-bottom: 20px;
	width: 80%;
	text-align: center;
	border-radius: 5px;
}

.seats {
	display: flex;
	flex-direction: column;
	align-items: center;
}

.row {
	display: flex;
	justify-content: center;
	margin-bottom: 5px;
}

.seat {
	width: 50px;
	height: 50px;
	margin: 5px;
	display: inline-block;
	text-align: center;
	line-height: 45px;
	border: 2px solid #ddd;
	border-radius: 5px;
	cursor: pointer;
	transition: all 0.3s ease;
}

.seat.available {
	background-color: #90ee90;
}

.seat.unavailable {
	background-color: #ffcccb;
	cursor: not-allowed;
}

.seat.selected {
	background-color: #add8e6;
}

.seat:hover:not(.unavailable) {
	border-color: #333;
}

.button-container {
	text-align: right;
	margin-top: auto;
	padding: 20px;
}

button {
	padding: 10px 20px;
	background-color: #007bff;
	color: white;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	transition: background-color 0.3s ease;
}

button:hover {
	background-color: #0056b3;
}

.left-h1style2 {
	line-height: 80px;
	font-size: 1.5rem;
	width: 65%;
	text-align: center;
}

.right-h1style2 {
	line-height: 40px;
	font-size: 1.5rem;
	width: 35%;
	text-align: center;
}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    
    function selectSeat(seatNumber) {
        var seatElement = document.getElementById('seat-' + seatNumber);
        if (seatElement.classList.contains('available')) {
            seatElement.classList.toggle('selected');
        }
    }
    
    
    

    function getSeatClass(seatStatus) {
        return seatStatus === '0' ? 'available' : 'unavailable';
    }


    function generateSeatHTML(seat) {
        return `
            <div id="seat-${seat.seatNumber}" data-seat-number="${seat.seatNumber}" class="seat ${getSeatClass(seat.seatStatus)}" onclick="selectSeat('${seat.seatNumber}')">${seat.seatNumber}
            </div>
        `;
    }


    function renderSeats(seats) {
        var seatsContainer = $('.seats');
        seatsContainer.empty();
        var seatRows = {};
        seats.forEach(function(seat) {
            var seatColumn = seat.seatColumn;
            if (!seatRows[seatColumn]) {
                seatRows[seatColumn] = [];
            }
            seatRows[seatColumn].push(seat);
        });

        for (var [column, seats] of Object.entries(seatRows)) {
            var rowDiv = $('<div class="row">'); 
            seats.forEach(function(seat) {
                rowDiv.append(generateSeatHTML(seat));
            });
            seatsContainer.append(rowDiv);
        }
    }
    
    function submitSelectedSeats() {
        var selectedSeats = document.querySelectorAll('.selected');
        var seatNumbers = [];
        selectedSeats.forEach(function(seatNumber) {
            seatNumbers.push(seatNumber.getAttribute('data-seat-number'));
        });
        return seatNumbers;
    }

    // 发送 AJAX 请求获取座位数据
    function getSeats(showTimesId) {
	    $.ajax({
	        url: '/Time/back-end/ticorder/TicketOrderServlet.do',
	        type: 'POST',
	        data: {
	            action: 'get_seats',
	            showTimesId: showTimesId
	        },
	        dataType: 'json',
	        success: function(response) {
	            renderSeats(response);
	            gettotalQuantity();
	        },
	        error: function(xhr, status, error) {
	            console.error('Error fetching seats:', error);
	        }
	    });
	}
    
    function gettotalQuantity() {
	    $.ajax({
	        url: '/Time/back-end/ticorder/TicketOrderServlet.do',
	        type: 'POST',
	        data: {action: 'get_totalQuantity'},
	        dataType: 'json',
	        success: function(data) {
	        	$("#totalQuantity").val(data.totalQuantity);
	        },
	        error: function(xhr, status, error) {
	            console.error('Error fetching seats:', error);
	        }
	    });
	}

    $(document).ready(function() {
    	
    	$("#purchaseButton").on("click", function () {
        	var TotalQuantity = document.getElementById("totalQuantity");
        	var seatNumbers = submitSelectedSeats();
            if(!(seatNumbers.length == TotalQuantity.value)){
            	alert("請選擇" + TotalQuantity.value + "個座位。");
            	return;
            }
            var status = document.getElementById("status").value;
            var showTimesId = document.getElementById("showTimesId").value;
            
            $.ajax({
		          url: "/Time/back-end/ticorder/TicketOrderServlet.do",
		          type: "POST",
		          data: {
		        	  action: "saveMemberdData_SeatNumber",
		        	  "seatNumbers[]": [seatNumbers],  
		        	  status: status,
		        	  showTimesId: showTimesId
		          },
		          success: function (response) {

		        	  window.location.href = "/Time/front-end/buytickets/buy_tickets_checkout.html";
		          },
		          error: function (xhr) {
		            console.log(xhr);
		          }
		    });
        });
    	
		// 發送AJAX請求到後端獲取存儲在Redis中的選擇數據
        $.ajax({
            url: "/Time/back-end/ticorder/TicketOrderServlet.do",
            type: "POST",
            data: {action: "getMemberData_Movie"},
            dataType: "json",
            success: function (data) {
                // 將獲取的數據顯示在指定的元素中
                var showTimesId = data.showTimesId;
                $("#movieName").text(data.movieName);
                $("#moviePlaybackType").text(data.moviePlaybackType);
                $("#showDate").text(data.showTimeDate);
                $("#showTimesId").val(showTimesId);
                getSeats(showTimesId);
                var showTimeText;
                switch(data.showTime) {
                case '0':
                    showTimeText = "　6：00";
                    break;
                case '1':
                    showTimeText = "　12：00";
                    break;
                case '2':
                    showTimeText = "　18：00";
                    break;
                }
                $("#showTime").text(showTimeText);
            },
            error: function (xhr) {
                console.log(xhr);
            }
        });
		
    });
    
    function fetchMemberName() {
        var xhr = new XMLHttpRequest();
        var url = "/Time/getMemberName?timestamp=" + new Date().getTime(); // 添加時間戳來防止緩存
        xhr.open("GET", url, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    var username = response.memberName;
                    var memberElement = document.getElementById('member');
                    if (username) {
                        memberElement.textContent =username;
                        document.querySelector('.auth-buttons99 button').textContent = "重新登入";
                    } else {
                        memberElement.textContent = "未登入會員";
                    }
                } else {
                    console.error("Error fetching member name: " + xhr.status);
                }
            }
        };
        xhr.send();
    }

    // 當頁面加載時獲取會員名稱
    window.onload = fetchMemberName;
        
	//原送出按鈕
    
    </script>
</head>
<body>
	<header>
		<div class="container99">
			<div class="logo">
				<h1>
					<a href="/Time/index.html" style="color: white; text-decoration: none;">Time影城</a>
				</h1>
			</div>
			<nav>
				<ul>
					<li><a href="/Time/front-end/movie/movie.html">電影</a></li>
					<li><a href="/Time/front-end/buytickets/buy_tickets_page.html">立即購票</a></li>
					<li><a href="#">周邊商品</a></li>
					<li><a href="/Time/front-end/article/home.jsp">討論區</a></li>
					<li><a href="#">會員中心</a></li>
								<li style="color:yellow; margin-top: 2px; margin-left: 30px;">  <i class="fas fa-user" style="margin-right: 5px;"></i></li>
					<li id="member" style="color:yellow; margin-top: 2px;  margin-left: -25px;">
    <span id="memberName"></span>
</li>
				</ul>
			</nav>
			<div class="auth-buttons99">
				<button style="color: black;">登入/註冊</button>
			</div>
		</div>
	</header>
	<main>

		<div style="display: flex;">
			<div class="left-h1style2">
				<span id="movieName"> </span>
				<!-- 電影名稱 -->
			</div>
			<div class="right-h1style2">
				<span id="showDate"> </span>
				<!-- 日期 -->
				<span id="showTime"> </span><br>
				<!-- 時間 -->
				<span id="moviePlaybackType"> </span>
			</div>
		</div>
		<!-- <h2>场次座位查询结果</h2> -->

		<!-- <p>场次ID: <span id="sessionId"></span></p> 显示场次ID -->

		<div class="cinema">
			<div class="screen">螢 幕</div>
			<div class="seats"></div>
		</div>
		<div class="button-container">
			<input type="hidden" id="status" value="1"> <input
				type="hidden" id="showTimesId" value=""> <input
				type="hidden" id="totalQuantity" value=""> <input
				id="purchaseButton" class="btn btn-primary btn-lg" type="button"
				value="下一步"></input>
		</div>

	</main>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js"
		integrity="sha384-skAcpIdS7UcVUC05LJ9Dxay8AXcDYfBJqt1CJ85S/CFujBsIzCIv+l9liuYLaMQ/"
		crossorigin="anonymous"></script>


	<!-- 頁尾Footer include -->
	<footer>
		<div class="footer">
			<div class="nav-links">
				<a href="#">工作機會</a> <a href="#">關於</a> <a href="#">客戶支援</a> <a
					href="#">聯繫我們</a> <a href="#">媒體報導</a> <a href="#">API</a>
			</div>
			<div class="social-icons">
				<a href="#"><i class="fab fa-twitter"></i></a> <a href="#"><i
					class="fab fa-facebook"></i></a> <a href="#"><i
					class="fab fa-reddit"></i></a> <a href="#"><i
					class="fab fa-instagram"></i></a> <a href="#"><i
					class="fab fa-youtube"></i></a>
			</div>
			<div class="copyright">© 2024 Time娛樂股份有限公司 ( Entertainment,
				Inc.) 在此提及的所有 商標 是其各自所有人的財產。台灣商頁影城有限公司台灣分公司 28992446</div>
			<div class="policy-links">
				<a href="#">隱私</a> <a href="#">法律聲明</a> <a href="#">條款</a> <a
					href="#">Cookie 政策</a> <a href="#">Cookie 設定</a>
			</div>
		</div>
	</footer>
</body>
</html>